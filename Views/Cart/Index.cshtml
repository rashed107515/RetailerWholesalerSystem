@model RetailerWholesalerSystem.Models.CartViewModel
@{
    ViewData["Title"] = "Your Cart";
}

<div class="container">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>Your Shopping Cart</h2>
        </div>
        <div class="col-md-4 text-right">
            <a asp-controller="Product" asp-action="BrowseWholesalerProducts" class="btn btn-primary">
                <i class="fa fa-shopping-basket"></i> Continue Shopping
            </a>
        </div>
    </div>

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }

    @if (Model.CartGroups.Any())
    {
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-light">
                        <div class="row">
                            <div class="col-md-6">Product</div>
                            <div class="col-md-2 text-center">Price</div>
                            <div class="col-md-2 text-center">Quantity</div>
                            <div class="col-md-2 text-center">Total</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @foreach (var group in Model.CartGroups)
        {
            <div class="card mb-4 wholesaler-group" data-wholesaler-id="@group.WholesalerId">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fa fa-store"></i> @group.WholesalerName
                    </h5>
                </div>
                <div class="card-body p-0">
                    @foreach (var item in group.Items)
                    {
                        <div class="row cart-item border-bottom p-3" data-item-id="@item.CartItemID">
                            <div class="col-md-6">
                                <div class="d-flex">
                                    @if (!string.IsNullOrEmpty(item.WholesalerProduct.Product.ImageURL))
                                    {
                                        <img src="@item.WholesalerProduct.Product.ImageURL" class="cart-product-image mr-3" 
                                             alt="@item.WholesalerProduct.Product.Name" style="width: 80px; height: 80px; object-fit: cover;">
                                    }
                                    else
                                    {
                                        <div class="bg-light text-center mr-3" style="width: 80px; height: 80px;">
                                            <i class="fa fa-image fa-2x text-muted mt-3"></i>
                                        </div>
                                    }
                                    <div>
                                        <h5>@item.WholesalerProduct.Product.Name</h5>
                                        <p class="text-muted mb-0">SKU: @item.WholesalerProduct.Product.ProductID</p>
                                        <div>
                                            <button type="button" class="btn btn-sm btn-link text-danger remove-item" 
                                                    data-item-id="@item.CartItemID">
                                                <i class="fa fa-trash"></i> Remove
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 text-center">
                                <span class="unit-price">@item.WholesalerProduct.Price.ToString("C")</span>
                            </div>
                            <div class="col-md-2 text-center">
                                <div class="input-group input-group-sm quantity-control">
                                    <div class="input-group-prepend">
                                        <button class="btn btn-outline-secondary decrease-quantity" type="button" 
                                                data-item-id="@item.CartItemID">-</button>
                                    </div>
                                    <input type="number" class="form-control text-center item-quantity" 
                                           value="@item.Quantity" min="@item.WholesalerProduct.MinimumOrderQuantity" 
                                           max="@item.WholesalerProduct.AvailableQuantity"
                                           data-item-id="@item.CartItemID"
                                           data-min-qty="@item.WholesalerProduct.MinimumOrderQuantity"
                                           data-max-qty="@item.WholesalerProduct.AvailableQuantity">
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-secondary increase-quantity" type="button" 
                                                data-item-id="@item.CartItemID">+</button>
                                    </div>
                                </div>
                                <small class="text-muted">
                                    Min: @item.WholesalerProduct.MinimumOrderQuantity | 
                                    Max: @item.WholesalerProduct.AvailableQuantity
                                </small>
                            </div>
                            <div class="col-md-2 text-center">
                                <span class="item-total font-weight-bold">
                                    @((item.Quantity * item.WholesalerProduct.Price).ToString("C"))
                                </span>
                            </div>
                        </div>
                    }
                </div>
                <div class="card-footer text-right">
                    <h5>Subtotal: <span class="group-subtotal">@group.SubTotal.ToString("C")</span></h5>
                </div>
            </div>
        }

        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Order Notes</h5>
                    </div>
                    <div class="card-body">
                        <textarea class="form-control" id="orderNotes" rows="3" 
                                  placeholder="Add notes for this order (optional)"></textarea>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Order Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Items Subtotal:</span>
                            <span>@Model.TotalAmount.ToString("C")</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Shipping:</span>
                            <span>To be calculated</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-2">
                            <h5>Total:</h5>
                            <h5 class="text-success">@Model.TotalAmount.ToString("C")</h5>
                        </div>
                        <form asp-action="Checkout" method="post">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-success btn-lg btn-block mt-3">
                                <i class="fa fa-check-circle"></i> Place Order
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="fa fa-shopping-cart fa-4x text-muted mb-3"></i>
                        <h3>Your cart is empty</h3>
                        <p class="lead">You haven't added any products to your cart yet.</p>
                        <a asp-controller="Product" asp-action="BrowseWholesalerProducts" class="btn btn-primary btn-lg">
                            <i class="fa fa-shopping-basket"></i> Start Shopping
                        </a>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Handle quantity increase
            $('.increase-quantity').click(function() {
                const itemId = $(this).data('item-id');
                const input = $('input.item-quantity[data-item-id="' + itemId + '"]');
                const currentValue = parseInt(input.val());
                const maxValue = parseInt(input.data('max-qty'));
                
                if (currentValue < maxValue) {
                    input.val(currentValue + 1);
                    updateCartItemQuantity(itemId, currentValue + 1);
                }
            });

    // Handle quantity decrease
    $('.decrease-quantity').click(function() {
        const itemId = $(this).data('item-id');
        const input = $('input.item-quantity[data-item-id="' + itemId + '"]');
        const currentValue = parseInt(input.val());
        const minValue = parseInt(input.data('min-qty'));

        if (currentValue > minValue) {
            input.val(currentValue - 1);
            updateCartItemQuantity(itemId, currentValue - 1);
        }
    });

    // Handle remove item
    $('.remove-item').click(function() {
        const itemId = $(this).data('item-id');
        removeCartItem(itemId);
    });

    // Function to update cart item quantity
    function updateCartItemQuantity(itemId, quantity) {
        $.ajax({
            url: '/Cart/UpdateQuantity',
            type: 'POST',
            data: { cartItemId: itemId, quantity: quantity },
            success: function(response) {
                if(response.success) {
                    updateCartTotals();
                } else {
                    alert(response.message);
                }
            }
        });
    }

    // Function to remove cart item
    function removeCartItem(itemId) {
        $.ajax({
            url: '/Cart/RemoveItem',
            type: 'POST',
            data: { cartItemId: itemId },
            success: function(response) {
                if(response.success) {
                    $('.cart-item[data-item-id="' + itemId + '"]').fadeOut(function() {
                        $(this).remove();
                        updateCartTotals();
                        checkEmptyCart();
                    });
                }
            }
        });
    }

    // Function to update cart totals
    function updateCartTotals() {
        // Update each wholesaler group subtotal
        $('.wholesaler-group').each(function() {
            let groupTotal = 0;
            $(this).find('.cart-item').each(function() {
                const quantity = parseInt($(this).find('.item-quantity').val());
                const unitPrice = parseFloat($(this).find('.unit-price').text().replace(/[^0-9.-]+/g, ''));
                const itemTotal = quantity * unitPrice;

                $(this).find('.item-total').text('$' + itemTotal.toFixed(2));
                groupTotal += itemTotal;
            });

            $(this).find('.group-subtotal').text('$' + groupTotal.toFixed(2));
        });

        // Update the overall total
        let cartTotal = 0;
        $('.item-total').each(function() {
            cartTotal += parseFloat($(this).text().replace(/[^0-9.-]+/g, ''));
        });

        $('.text-success').text('$' + cartTotal.toFixed(2));
    }

    // Function to check if cart is empty
    function checkEmptyCart() {
        if($('.cart-item').length === 0) {
            location.reload(); // Reload to show empty cart view
        }
    }
         });
    </script>
}